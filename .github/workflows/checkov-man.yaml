name: 'checkov man'
on:
  workflow_dispatch:
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # An automatically generated secret provided by GitHub for use in GitHub Actions.
jobs:
  checkov:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v3
        with:
          ref: main
      - name: Test with Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@master
        with:
          file: ./main.tf
          directory: .
          output_format: cli # Report output format
          output_file_path: /checkov/module/ # Name of the output folder to save the chosen output formats
          framework: terraform # Filter scan to run only on specific infrastructure code frameworks
          soft_fail: 'true' # Runs checks but always returns a 0 exit code    
      - name: Test with Checkov - example
        id: checkov-example
        uses: bridgecrewio/checkov-action@master
        with:
          file: ./example/main.tf
          directory: ./example
          output_format: cli # Report output format
          output_file_path: /checkov/example/ # Name of the output folder to save the chosen output formats
          framework: terraform # Filter scan to run only on specific infrastructure code frameworks
          soft_fail: 'true' # Runs checks but always returns a 0 exit code              
          
      - name: Check for changes in 'checkov/module' and 'checkov/example' directories
        id: check_changes
        run: |
          if git status --porcelain './checkov/module' './checkov/example' | grep -q .; then
            echo "Changes found in 'checkov/module' or 'checkov/example' directories."
            echo "::set-output name=changes::true"
          else
            echo "No changes found in 'checkov/module' or 'checkov/example' directories."
            echo "::set-output name=changes::false"
          fi

      # Commit the changes to the repository only if changes were found.
      - name: Commit Results
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Action - terraform-module-scanner"
          git add './checkov/module' './checkov/example'
          git commit -m "Resulting from Checkov"
          git push