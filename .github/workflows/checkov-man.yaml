name: 'checkov man'
on:
  workflow_dispatch:
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # An automatically generated secret provided by GitHub for use in GitHub Actions.
jobs:
  checkov:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python 3.8
        uses: actions/setup-python@v4
        with:
          python-version: 3.8
      - name: Test with Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: /example
          output_format: cli # Report output format
          output_file_path: /checkov/example/ # Name of the output folder to save the chosen output formats
          framework: terraform # Filter scan to run only on specific infrastructure code frameworks
          soft_fail: 'true' # Runs checks but always returns a 0 exit code    
      - name: Check for changes in 'checkov/module' and 'checkov/example' directories
        id: check_changes
        run: |
          if git status --porcelain './checkov/module' './checkov/example' | grep -q .; then
            echo "Changes found in 'checkov/module' or 'checkov/example' directories."
            echo "::set-output name=changes::true"
          else
            echo "No changes found in 'checkov/module' or 'checkov/example' directories."
            echo "::set-output name=changes::false"
          fi

      # Commit the changes to the repository only if changes were found.
      - name: Commit Results
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Action - terraform-module-scanner"
          git add './checkov/module' './checkov/example'
          git commit -m "Resulting from Checkov"
          git push